{% extends 'base.html' %}

{% block title %}è‡ªåŠ¨ç”Ÿæˆè§†é¢‘ - AutoMovie{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>ğŸ¬ è‡ªåŠ¨ç”Ÿæˆè§†é¢‘</h1>
        <p class="page-description">ä¸€é”®å®Œæˆä»æ–‡æ¡ˆã€å›¾ç‰‡ã€è¯­éŸ³ã€å­—å¹•ã€èƒŒæ™¯éŸ³ä¹åœ¨åˆ°è§†é¢‘çš„å…¨æµç¨‹è‡ªåŠ¨åŒ–ç”Ÿæˆ</p>
    </div>



    <!-- è‡ªåŠ¨ç”Ÿæˆæ§åˆ¶åŒº -->
    <div class="generation-panel">
        <div class="generation-header">
            <h3>ğŸš€ è‡ªåŠ¨ç”Ÿæˆæ§åˆ¶</h3>
            <div class="generation-options">
                <label class="generation-count-label">
                    ç”Ÿæˆæ¬¡æ•°
                    <input type="number" id="generation-count" min="1" max="100" value="1" data-config-value="1">
                    æ¬¡
                </label>
            </div>
        </div>
        
        <div class="generation-button-container">
            <button id="auto-generate-btn" class="auto-generate-button">
                <div class="button-icon">ğŸ¬</div>
                <div class="button-text">
                    <div class="button-title">è‡ªåŠ¨ç”Ÿæˆè§†é¢‘</div>
                    <div class="button-subtitle">ä¸€é”®å®Œæˆå…¨æµç¨‹</div>
                </div>
            </button>
        </div>
        
        <div class="generation-progress" id="generation-progress" style="display: none;">
            <div class="progress-header">
                <span class="progress-title">ç”Ÿæˆè¿›åº¦</span>
                <span class="progress-percentage">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            <div class="progress-steps">
                <div class="step" data-step="project">ğŸ“ åˆ›å»ºé¡¹ç›®</div>
                <div class="step" data-step="text">ğŸ“ ç”Ÿæˆæ–‡æ¡ˆ</div>
                <div class="step" data-step="format">ğŸ“‹ æ ¼å¼åŒ–æ–‡æ¡ˆ</div>
                <div class="step" data-step="image">ğŸ–¼ï¸ å›¾åƒç”Ÿæˆ</div>
                <div class="step" data-step="audio">ğŸµ éŸ³é¢‘ç”Ÿæˆ</div>
                <div class="step" data-step="video">ğŸ¬ è§†é¢‘åˆæˆ</div>
            </div>
        </div>
    </div>

    <!-- å®æ—¶æ—¥å¿— -->
    <div class="log-panel">
        <div class="log-header">
            <h3>ğŸ“Š ç”Ÿæˆæ—¥å¿—</h3>
            <div class="log-controls">
                <button id="clear-log" class="btn-secondary">æ¸…ç©ºæ—¥å¿—</button>
                <button id="export-log" class="btn-secondary">å¯¼å‡ºæ—¥å¿—</button>
            </div>
        </div>
        <div class="log-container" id="log-container">
            <div class="log-entry info">
                <span class="log-time">[{{ current_time }}]</span>
                <span class="log-level">[INFO]</span>
                <span class="log-message">ç³»ç»Ÿå·²å°±ç»ªï¼Œç­‰å¾…å¼€å§‹è‡ªåŠ¨ç”Ÿæˆ...</span>
            </div>
        </div>
    </div>

    <!-- å†å²è®°å½• -->
    <div class="history-panel">
        <div class="history-header">
            <h3>ğŸ“š ç”Ÿæˆå†å²</h3>
            <div class="history-controls">
                <button id="refresh-history" class="btn-secondary">åˆ·æ–°</button>
                <button id="clear-history" class="btn-secondary">æ¸…ç©ºå†å²</button>
            </div>
        </div>
        <div class="history-container" id="history-container">
            <div class="history-empty">
                <div class="empty-icon">ğŸ“</div>
                <div class="empty-text">æš‚æ— ç”Ÿæˆå†å²</div>
                <div class="empty-subtitle">å®Œæˆç¬¬ä¸€æ¬¡è‡ªåŠ¨ç”Ÿæˆåï¼Œå†å²è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
            </div>
        </div>
    </div>
</div>

<!-- è§†é¢‘æ’­æ”¾å™¨æ¨¡æ€æ¡† -->
<div id="video-modal" class="video-modal">
    <div class="video-modal-content">
        <div class="video-modal-header">
            <div class="video-modal-title" id="video-modal-title">è§†é¢‘æ’­æ”¾</div>
            <button class="video-modal-close" id="video-modal-close">&times;</button>
        </div>
        <div class="video-modal-body">
            <video id="video-player" controls>
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
            </video>
        </div>
    </div>
</div>

<style>


.generation-panel {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.generation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.generation-options {
    display: flex;
    gap: 16px;
}

.generation-options label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #666;
}

.generation-count-label {
    display: flex;
    align-items: center;
    gap: 8px;
}

.generation-count-label input[type="number"] {
    width: 70px;
    padding: 4px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    text-align: center;
}

.generation-button-container {
    display: flex;
    justify-content: center;
    margin: 32px 0;
}

.auto-generate-button {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px 40px;
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(0,123,255,0.3);
}

.auto-generate-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,123,255,0.4);
}

.auto-generate-button:disabled {
    background: #6c757d;
    cursor: not-allowed;
    box-shadow: none;
}

.button-icon {
    font-size: 32px;
}

.button-text {
    text-align: left;
}

.button-title {
    font-weight: bold;
    margin-bottom: 4px;
}

.button-subtitle {
    font-size: 14px;
    opacity: 0.9;
}

.generation-progress {
    margin-top: 24px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
}

.progress-title {
    font-weight: bold;
}

.progress-percentage {
    color: #007bff;
    font-weight: bold;
}

.progress-bar {
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 16px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #007bff, #28a745);
    width: 0%;
    transition: width 0.3s ease;
}

.progress-steps {
    display: flex;
    justify-content: space-between;
    gap: 8px;
}

.step {
    flex: 1;
    text-align: center;
    padding: 8px;
    background: white;
    border-radius: 6px;
    font-size: 14px;
    color: #666;
    border: 2px solid #e9ecef;
}

.step.active {
    border-color: #007bff;
    color: #007bff;
    background: #e3f2fd;
}

.step.completed {
    border-color: #28a745;
    color: #28a745;
    background: #d4edda;
}

.step.error {
    border-color: #dc3545;
    color: #dc3545;
    background: #f8d7da;
}

.log-panel, .history-panel {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.log-header, .history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.log-controls, .history-controls {
    display: flex;
    gap: 8px;
}

.log-container {
    background: #000;
    color: #00ff00;
    padding: 16px;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    height: 300px;
    overflow-y: auto;
}

.log-entry {
    margin-bottom: 4px;
    word-wrap: break-word;
}

.log-entry.info { color: #00ff00; }
.log-entry.warning { color: #ffff00; }
.log-entry.error { color: #ff4444; }
.log-entry.success { color: #00ffff; }

.log-time {
    color: #888;
}

.log-level {
    font-weight: bold;
    margin-right: 8px;
}

.history-container {
    min-height: 200px;
}

.history-empty {
    text-align: center;
    padding: 40px;
    color: #666;
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
}

.empty-text {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 8px;
}

.empty-subtitle {
    font-size: 14px;
}

.btn-secondary {
    padding: 8px 16px;
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s ease;
}

.btn-secondary:hover {
    background: #5a6268;
}

/* å†å²é¢æ¿æ ·å¼ */
.history-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 8px;
    background: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
}

.history-item:hover {
    background: #e9ecef;
    border-color: #007bff;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.history-item-icon {
    font-size: 24px;
    margin-right: 12px;
    color: #007bff;
}

.history-item-content {
    flex: 1;
}

.history-item-title {
    font-weight: bold;
    color: #333;
    margin-bottom: 4px;
}

.history-item-info {
    display: flex;
    gap: 16px;
    font-size: 12px;
    color: #666;
}

.history-item-time {
    color: #007bff;
}

.history-item-size {
    color: #28a745;
}

.history-item-actions {
    display: flex;
    gap: 8px;
}

.history-action-btn {
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
}

.history-play-btn {
    background: #007bff;
    color: white;
}

.history-play-btn:hover {
    background: #0056b3;
}

.history-delete-btn {
    background: #dc3545;
    color: white;
}

.history-delete-btn:hover {
    background: #c82333;
}

.history-loading {
    text-align: center;
    padding: 20px;
    color: #666;
}

.history-loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* è§†é¢‘æ’­æ”¾å™¨æ¨¡æ€æ¡† */
.video-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
}

.video-modal-content {
    position: relative;
    margin: 1% auto;
    width: 95%;
    max-width: 1400px;
    max-height: 95vh;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.video-modal-header {
    padding: 12px 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.video-modal-title {
    font-weight: bold;
    color: #333;
}

.video-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.video-modal-close:hover {
    color: #333;
}

.video-modal-body {
    padding: 10px;
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 0;
    overflow: hidden;
}

.video-modal video {
    max-width: calc(100% - 20px);
    max-height: calc(95vh - 80px);
    height: auto;
    width: auto;
    display: block;
    object-fit: contain;
}
</style>

<script>
// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    checkProjectStatus();
    loadGenerationHistory();
    loadGenerationCountSettings();
    
    // åˆå§‹åŒ–Djangoæ—¥å¿—ç³»ç»Ÿ
    initializeDjangoLogSystem();
    
    // ç»‘å®šäº‹ä»¶
    document.getElementById('auto-generate-btn').addEventListener('click', startAutoGeneration);
    document.getElementById('clear-log').addEventListener('click', clearLog);
    document.getElementById('export-log').addEventListener('click', exportLog);
    document.getElementById('refresh-history').addEventListener('click', loadGenerationHistory);
    document.getElementById('clear-history').addEventListener('click', clearHistory);
    
    // è¿ç»­ç”Ÿæˆç›¸å…³äº‹ä»¶
    document.getElementById('generation-count').addEventListener('change', saveGenerationCountSettings);
});

// Djangoæ—¥å¿—ç³»ç»Ÿç›¸å…³å˜é‡
let logUpdateInterval = null;
let lastLogTimestamp = 0;

// åˆå§‹åŒ–Djangoæ—¥å¿—ç³»ç»Ÿ
function initializeDjangoLogSystem() {
    addCustomLog('info', 'Djangoæ—¥å¿—ç³»ç»Ÿå·²åˆå§‹åŒ–');
    
    // å¼€å§‹å®šæœŸè·å–æ—¥å¿—
    startLogPolling();
}

// å¼€å§‹æ—¥å¿—è½®è¯¢
function startLogPolling() {
    // ç«‹å³è·å–ä¸€æ¬¡æ—¥å¿—
    fetchDjangoLogs();
    
    // æ¯2ç§’è·å–ä¸€æ¬¡æ–°æ—¥å¿—
    logUpdateInterval = setInterval(fetchDjangoLogs, 2000);
}

// åœæ­¢æ—¥å¿—è½®è¯¢
function stopLogPolling() {
    if (logUpdateInterval) {
        clearInterval(logUpdateInterval);
        logUpdateInterval = null;
    }
}

// è·å–Djangoæ—¥å¿—
function fetchDjangoLogs() {
    const url = lastLogTimestamp > 0 
        ? `/get_django_logs/?since=${lastLogTimestamp}&max_logs=20`
        : '/get_django_logs/?max_logs=50';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.logs && data.logs.length > 0) {
                // æ˜¾ç¤ºæ–°æ—¥å¿—
                data.logs.forEach(log => {
                    displayLogEntry(log);
                });
                
                // æ›´æ–°æ—¶é—´æˆ³
                lastLogTimestamp = data.timestamp;
            }
        })
        .catch(error => {
            console.error('è·å–Djangoæ—¥å¿—å¤±è´¥:', error);
        });
}

// æ˜¾ç¤ºæ—¥å¿—æ¡ç›®
function displayLogEntry(log) {
    const container = document.getElementById('log-container');
    
    // æ˜ å°„æ—¥å¿—çº§åˆ«åˆ°CSSç±»
    const levelMap = {
        'INFO': 'info',
        'WARNING': 'warning',
        'ERROR': 'error',
        'SUCCESS': 'success',
        'DEBUG': 'info'
    };
    
    const cssClass = levelMap[log.level] || 'info';
    
    const entry = document.createElement('div');
    entry.className = `log-entry ${cssClass}`;
    entry.innerHTML = `
        <span class="log-time">[${log.timestamp}]</span>
        <span class="log-level">[${log.level}]</span>
        <span class="log-message">${log.message}</span>
    `;
    
    container.appendChild(entry);
    container.scrollTop = container.scrollHeight;
    
    // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡ï¼Œé¿å…å†…å­˜å ç”¨è¿‡å¤š
    const maxEntries = 200;
    while (container.children.length > maxEntries) {
        container.removeChild(container.firstChild);
    }
}

// æ·»åŠ è‡ªå®šä¹‰æ—¥å¿—
function addCustomLog(level, message, module = 'AutoVideo') {
    const data = {
        level: level.toUpperCase(),
        message: message,
        module: module
    };
    
    fetch('/add_custom_log/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('æ·»åŠ æ—¥å¿—å¤±è´¥:', data.error);
        }
    })
    .catch(error => {
        console.error('æ·»åŠ æ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯:', error);
    });
}

// å…¼å®¹æ€§å‡½æ•° - ä¿æŒåŸæœ‰çš„addLogå‡½æ•°æ¥å£
function addLog(level, message) {
    addCustomLog(level, message);
}

// æ£€æŸ¥é¡¹ç›®çŠ¶æ€
function checkProjectStatus() {
    addLog('info', 'å¼€å§‹æ£€æŸ¥é¡¹ç›®çŠ¶æ€...');
    
    // æ£€æŸ¥å½“å‰é¡¹ç›®
    fetch('/get_current_project/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.project) {
                updateStatusItem('project', 'ready', data.project.project_name, 'âœ…');
                checkProjectAssets(data.project.project_path);
            } else {
                updateStatusItem('project', 'error', 'æœªé€‰æ‹©é¡¹ç›®', 'âŒ');
                addLog('error', 'æœªæ‰¾åˆ°å½“å‰é¡¹ç›®ï¼Œè¯·å…ˆåœ¨é¡¹ç›®ç®¡ç†é¡µé¢åˆ›å»ºæˆ–é€‰æ‹©é¡¹ç›®');
            }
        })
        .catch(error => {
            updateStatusItem('project', 'error', 'æ£€æŸ¥å¤±è´¥', 'âŒ');
            addLog('error', 'æ£€æŸ¥é¡¹ç›®çŠ¶æ€å¤±è´¥: ' + error.message);
        });
}

// æ£€æŸ¥é¡¹ç›®ç´ æ
function checkProjectAssets(projectPath) {
    // æ£€æŸ¥æ–‡æ¡ˆ
    fetch(`/load_paper_json/?project_path=${encodeURIComponent(projectPath)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.script && data.script.length > 0) {
                updateStatusItem('text', 'ready', `${data.script.length} æ®µæ–‡æ¡ˆ`, 'âœ…');
            } else {
                updateStatusItem('text', 'warning', 'æ— æ–‡æ¡ˆ', 'âš ï¸');
            }
        })
        .catch(() => {
            updateStatusItem('text', 'error', 'æ£€æŸ¥å¤±è´¥', 'âŒ');
        });
    
    // æ£€æŸ¥å›¾åƒå’ŒéŸ³é¢‘ - è¿™é‡Œéœ€è¦å®ç°ç›¸åº”çš„API
    // æš‚æ—¶æ¨¡æ‹Ÿæ£€æŸ¥
    setTimeout(() => {
        updateStatusItem('image', 'warning', '0 å¼ å›¾åƒ', 'âš ï¸');
        updateStatusItem('audio', 'warning', '0 ä¸ªéŸ³é¢‘', 'âš ï¸');
        
        // æ£€æŸ¥å®Œæˆåå¯ç”¨æŒ‰é’®
        checkGenerationReadiness();
    }, 1000);
}

// æ›´æ–°çŠ¶æ€é¡¹
function updateStatusItem(type, status, value, indicator) {
    const item = document.getElementById(`${type}-status`);
    const valueEl = document.getElementById(`${type}-count`);
    const indicatorEl = document.getElementById(`${type}-indicator`);
    
    if (item && valueEl && indicatorEl) {
        item.className = `status-item ${status}`;
        valueEl.textContent = value;
        indicatorEl.textContent = indicator;
    }
}

// æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼€å§‹ç”Ÿæˆ
function checkGenerationReadiness() {
    const projectIndicator = document.getElementById('project-indicator');
    const textIndicator = document.getElementById('text-indicator');
    const button = document.getElementById('auto-generate-btn');
    
    if (button) {
        // è‡ªåŠ¨ç”Ÿæˆè§†é¢‘æŒ‰é’®å§‹ç»ˆå¯ç”¨ï¼Œå› ä¸ºå®ƒæ˜¯å®Œæ•´çš„ä»é›¶å¼€å§‹æµç¨‹
        button.disabled = false;
        addLog('success', 'è‡ªåŠ¨ç”Ÿæˆè§†é¢‘åŠŸèƒ½å·²å°±ç»ªï¼Œå¯ä»¥ä¸€é”®å®Œæˆå…¨æµç¨‹');
        
        // æ˜¾ç¤ºå½“å‰é¡¹ç›®çŠ¶æ€ä¿¡æ¯
        if (projectIndicator && textIndicator) {
            const projectReady = projectIndicator.textContent === 'âœ…';
            const textReady = textIndicator.textContent === 'âœ…';
            
            if (projectReady && textReady) {
                addLog('info', 'æ£€æµ‹åˆ°ç°æœ‰é¡¹ç›®å’Œæ–‡æ¡ˆï¼Œè‡ªåŠ¨ç”Ÿæˆå°†åœ¨æ­¤åŸºç¡€ä¸Šç»§ç»­');
            } else {
                addLog('info', 'å°†åˆ›å»ºæ–°é¡¹ç›®å¹¶ç”Ÿæˆå®Œæ•´å†…å®¹');
            }
        }
    }
}

// å¼€å§‹è‡ªåŠ¨ç”Ÿæˆ
function startAutoGeneration() {
    const button = document.getElementById('auto-generate-btn');
    const progress = document.getElementById('generation-progress');
    const generationCountInput = document.getElementById('generation-count');
    
    // å®‰å…¨æ£€æŸ¥ï¼Œé¿å…nullå€¼é”™è¯¯
    const generationCount = generationCountInput ? parseInt(generationCountInput.value) || 1 : 1;
    
    if (button) button.disabled = true;
    if (progress) progress.style.display = 'block';
    
    if (generationCount > 1) {
        addLog('info', `å¼€å§‹è¿ç»­è‡ªåŠ¨ç”Ÿæˆè§†é¢‘æµç¨‹ï¼Œå…± ${generationCount} æ¬¡...`);
        startContinuousGeneration(generationCount, 1);
    } else {
        addLog('info', 'å¼€å§‹è‡ªåŠ¨ç”Ÿæˆè§†é¢‘æµç¨‹...');
        simulateGeneration(1, 1);
    }
}

// è¿ç»­ç”Ÿæˆæ§åˆ¶å‡½æ•°
function startContinuousGeneration(totalCount, currentRound) {
    addLog('info', `å¼€å§‹ç¬¬ ${currentRound}/${totalCount} è½®ç”Ÿæˆ...`);
    simulateGeneration(currentRound, totalCount);
}

// çœŸæ­£çš„è‡ªåŠ¨ç”Ÿæˆè§†é¢‘æµç¨‹
async function simulateGeneration(currentRound = 1, totalRounds = 1) {
    const steps = [
        { key: 'project', name: 'åˆ›å»ºé¡¹ç›®', api: 'create_project' },
        { key: 'text', name: 'ç”Ÿæˆæ–‡æ¡ˆ', api: 'generate_text' },
        { key: 'format', name: 'æ ¼å¼åŒ–æ–‡æ¡ˆ', api: 'format_text' },
        { key: 'image', name: 'æ‰¹é‡ç”Ÿæˆå›¾åƒ', api: 'batch_generate_images' },
        { key: 'audio', name: 'æ‰¹é‡ç”ŸæˆéŸ³é¢‘', api: 'batch_generate_audios' },
        { key: 'video', name: 'ç”Ÿæˆè§†é¢‘', api: 'generate_video' }
    ];
    
    let currentStep = 0;
    let projectPath = null;
    
    async function nextStep() {
        if (currentStep < steps.length) {
            const step = steps[currentStep];
            updateProgressStep(step.key, 'active');
            addCustomLog('info', `[ç¬¬${currentRound}è½®] æ­£åœ¨æ‰§è¡Œ: ${step.name}`);
            
            try {
                // æ‰§è¡Œå¯¹åº”çš„APIè°ƒç”¨
                const result = await executeStep(step, projectPath, currentRound);
                
                if (result.success) {
                    // å¦‚æœæ˜¯åˆ›å»ºé¡¹ç›®æ­¥éª¤ï¼Œä¿å­˜é¡¹ç›®è·¯å¾„
                    if (step.key === 'project' && result.project_path) {
                        projectPath = result.project_path;
                        addCustomLog('success', `é¡¹ç›®åˆ›å»ºæˆåŠŸ: ${result.project_path}`);
                    } else {
                        addCustomLog('success', `${step.name}å®Œæˆ: ${result.message || 'æ“ä½œæˆåŠŸ'}`);
                    }
                    
                    updateProgressStep(step.key, 'completed');
                    updateProgress((currentStep + 1) / steps.length * 100);
                    currentStep++;
                    
                    // çŸ­æš‚å»¶è¿Ÿåç»§ç»­ä¸‹ä¸€æ­¥
                    setTimeout(nextStep, 500);
                } else {
                    throw new Error(result.error || `${step.name}å¤±è´¥`);
                }
            } catch (error) {
                addCustomLog('error', `[ç¬¬${currentRound}è½®] ${step.name}å¤±è´¥: ${error.message}`);
                updateProgressStep(step.key, 'error');
                
                // å¤±è´¥æ—¶åœæ­¢å½“å‰è½®æ¬¡
                document.getElementById('auto-generate-btn').disabled = false;
                document.getElementById('generation-progress').style.display = 'none';
                return;
            }
        } else {
            addCustomLog('success', `ç¬¬ ${currentRound}/${totalRounds} è½®ç”Ÿæˆå®Œæˆï¼`);
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦ç»§ç»­ä¸‹ä¸€è½®
            if (currentRound < totalRounds) {
                // é‡ç½®è¿›åº¦æ¡
                setTimeout(() => {
                    resetProgress();
                    startContinuousGeneration(totalRounds, currentRound + 1);
                }, 1000);
            } else {
                // æ‰€æœ‰è½®æ¬¡å®Œæˆ
                addCustomLog('success', `æ‰€æœ‰ ${totalRounds} è½®è‡ªåŠ¨ç”Ÿæˆå®Œæˆï¼`);
                document.getElementById('auto-generate-btn').disabled = false;
                document.getElementById('generation-progress').style.display = 'none';
                loadGenerationHistory();
            }
        }
    }
    
    nextStep();
}

// æ‰§è¡Œå…·ä½“çš„æ­¥éª¤
async function executeStep(step, projectPath, currentRound) {
    switch (step.key) {
        case 'project':
            return await createProject(currentRound);
        case 'text':
            return await generateText(projectPath);
        case 'format':
            return await formatText(projectPath);
        case 'image':
            return await batchGenerateImages(projectPath);
        case 'audio':
            return await batchGenerateAudios(projectPath);
        case 'video':
            return await generateVideo(projectPath);
        default:
            throw new Error(`æœªçŸ¥æ­¥éª¤: ${step.key}`);
    }
}

// åˆ›å»ºé¡¹ç›®
async function createProject(roundNumber) {
    // ä½¿ç”¨ç®€å•çš„å‘½åè§„åˆ™ï¼šA + æ—¶é—´æˆ³
    const timestamp = new Date().toISOString().slice(0,19).replace(/[-:T]/g, '').slice(0,12);
    const projectName = `A${timestamp}`;
    const projectDesc = `è‡ªåŠ¨ç”Ÿæˆçš„è§†é¢‘é¡¹ç›® - ç¬¬${roundNumber}è½®`;
    
    const response = await fetch('/create_project/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            project_name: projectName,
            project_desc: projectDesc
        })
    });
    
    return await response.json();
}

// ç”Ÿæˆæ–‡æ¡ˆ
async function generateText(projectPath) {
    // è·å–config.iniä¸­PROMPT_CONFIGæŒ‡å‘çš„æ–‡æ¡ˆç”Ÿæˆæç¤ºè¯
    const promptResponse = await fetch('/load_default_prompt/');
    const promptData = await promptResponse.json();
    
    if (!promptData.success) {
        throw new Error('æ— æ³•åŠ è½½é»˜è®¤æç¤ºè¯');
    }
    
    const response = await fetch('/generate_text/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            prompt: promptData.content || 'è¯·ç”Ÿæˆä¸€ä¸ªæœ‰è¶£çš„çŸ­è§†é¢‘æ–‡æ¡ˆ'
        })
    });
    
    return await response.json();
}

// æ ¼å¼åŒ–æ–‡æ¡ˆ
async function formatText(projectPath) {
    try {
        // ä»config.iniè¯»å–æ´»åŠ¨æ ¼å¼åŒ–æç¤ºè¯æ–‡ä»¶å†…å®¹
        const formatPromptResponse = await fetch('/load_active_format_prompt_content/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const formatPromptData = await formatPromptResponse.json();
        if (!formatPromptData.success) {
            throw new Error(`è·å–æ ¼å¼åŒ–æç¤ºè¯å¤±è´¥: ${formatPromptData.error}`);
        }
        
        // ä½¿ç”¨è·å–åˆ°çš„æ ¼å¼åŒ–æç¤ºè¯è°ƒç”¨format_textæ¥å£
        const response = await fetch('/format_text/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                prompt: formatPromptData.content,
                project_path: projectPath
            })
        });
        
        return await response.json();
    } catch (error) {
        return {
            success: false,
            error: error.message
        };
    }
}

// æ‰¹é‡ç”Ÿæˆå›¾åƒ
async function batchGenerateImages(projectPath) {
    try {
        // é¦–å…ˆä»parameter.iniè·å–sentence_count
        const paramResponse = await fetch(`/load_parameter_config/?project_path=${encodeURIComponent(projectPath)}`);
        const paramData = await paramResponse.json();
        
        let sentenceCount = 8; // é»˜è®¤å€¼
        if (paramData.success && paramData.sentence_count !== undefined) {
            sentenceCount = parseInt(paramData.sentence_count);
        }
        
        addCustomLog('info', `å¼€å§‹æ‰¹é‡ç”Ÿæˆ ${sentenceCount} å¼ å›¾åƒ...`);
        
        // æ ¹æ®sentenceCountç”Ÿæˆå›¾åƒï¼Œè€Œä¸æ˜¯ä¾èµ–paper.json
        for (let i = 1; i <= sentenceCount; i++) {
            addCustomLog('info', `æ­£åœ¨ç”Ÿæˆç¬¬ ${i}/${sentenceCount} å¼ å›¾åƒ...`);
            
            try {
                const response = await fetch('/generate_image/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({
                        script_id: i,
                        project_path: projectPath
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯paper.jsonç›¸å…³é”™è¯¯
                    if (i === 1) {
                        const errorMessage = result.error || result.message || '';
                        if (errorMessage.includes('paper.json') || 
                            errorMessage.includes('æ— æ³•åŠ è½½paper.jsonæ•°æ®') ||
                            errorMessage.includes('é¡¹ç›®æ–‡æ¡ˆæœªæ ¼å¼åŒ–')) {
                            
                            throw new Error('é¡¹ç›®æ–‡æ¡ˆæœªæ ¼å¼åŒ–ï¼Œè¯·å…ˆåˆ°æ–‡æ¡ˆç”Ÿæˆé¡µé¢å®Œæˆæ–‡æ¡ˆæ ¼å¼åŒ–');
                        }
                    }
                    
                    // å…¶ä»–é”™è¯¯è®°å½•ä½†ä¸ä¸­æ–­æ‰¹é‡ç”Ÿæˆ
                    addCustomLog('warning', `ç¬¬ ${i} å¼ å›¾åƒç”Ÿæˆå¤±è´¥: ${result.error || result.message}`);
                } else {
                    addCustomLog('info', `ç¬¬ ${i} å¼ å›¾åƒç”ŸæˆæˆåŠŸ`);
                }
            } catch (error) {
                // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå›¾ç‰‡çš„paper.jsoné”™è¯¯ï¼Œé‡æ–°æŠ›å‡º
                if (i === 1 && error.message.includes('é¡¹ç›®æ–‡æ¡ˆæœªæ ¼å¼åŒ–')) {
                    throw error;
                }
                
                // å…¶ä»–é”™è¯¯è®°å½•ä½†ä¸ä¸­æ–­æ‰¹é‡ç”Ÿæˆ
                addCustomLog('warning', `ç¬¬ ${i} å¼ å›¾åƒç”Ÿæˆå‡ºé”™: ${error.message}`);
            }
            
            // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        return {
            success: true,
            message: `æ‰¹é‡ç”Ÿæˆå®Œæˆï¼Œå…±å¤„ç† ${sentenceCount} å¼ å›¾åƒ`
        };
    } catch (error) {
        return {
            success: false,
            error: error.message
        };
    }
}

// æ‰¹é‡ç”ŸæˆéŸ³é¢‘
async function batchGenerateAudios(projectPath) {
    try {
        // é¦–å…ˆä»parameter.iniè·å–sentence_count
        const paramResponse = await fetch(`/load_parameter_config/?project_path=${encodeURIComponent(projectPath)}`);
        const paramData = await paramResponse.json();
        
        let sentenceCount = 8; // é»˜è®¤å€¼
        if (paramData.success && paramData.sentence_count !== undefined) {
            sentenceCount = parseInt(paramData.sentence_count);
        }
        
        addCustomLog('info', `å¼€å§‹æ‰¹é‡ç”Ÿæˆ ${sentenceCount} ä¸ªéŸ³é¢‘...`);
        
        // æ ¹æ®sentenceCountç”ŸæˆéŸ³é¢‘ï¼Œè€Œä¸æ˜¯ä¾èµ–paper.json
        for (let i = 1; i <= sentenceCount; i++) {
            addCustomLog('info', `æ­£åœ¨ç”Ÿæˆç¬¬ ${i}/${sentenceCount} ä¸ªéŸ³é¢‘...`);
            
            try {
                // ä»parameter.iniè·å–å¯¹åº”çš„æ–‡æ¡ˆå†…å®¹
                let text = '';
                if (paramData.success && paramData.paper_content) {
                    const lineKey = `line_${i}`;
                    text = paramData.paper_content[lineKey] || '';
                }
                
                const response = await fetch('/generate_audio/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({
                        script_id: i,
                        project_path: projectPath,
                        text: text
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    // å…¶ä»–é”™è¯¯è®°å½•ä½†ä¸ä¸­æ–­æ‰¹é‡ç”Ÿæˆ
                    addCustomLog('warning', `ç¬¬ ${i} ä¸ªéŸ³é¢‘ç”Ÿæˆå¤±è´¥: ${result.error || result.message}`);
                } else {
                    addCustomLog('info', `ç¬¬ ${i} ä¸ªéŸ³é¢‘ç”ŸæˆæˆåŠŸ`);
                }
            } catch (error) {
                // é”™è¯¯è®°å½•ä½†ä¸ä¸­æ–­æ‰¹é‡ç”Ÿæˆ
                addCustomLog('warning', `ç¬¬ ${i} ä¸ªéŸ³é¢‘ç”Ÿæˆå‡ºé”™: ${error.message}`);
            }
            
            // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        return {
            success: true,
            message: `æ‰¹é‡ç”Ÿæˆå®Œæˆï¼Œå…±å¤„ç† ${sentenceCount} ä¸ªéŸ³é¢‘`
        };
    } catch (error) {
        return {
            success: false,
            error: error.message
        };
    }
}

// ç”Ÿæˆè§†é¢‘
async function generateVideo(projectPath) {
    const response = await fetch('/generate_video/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            project_path: projectPath,
            resolution: { width: 1080, height: 1920 },
            quality: { preset: 'medium' },
            filename: `auto_generated_video_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.mp4`
        })
    });
    
    return await response.json();
}

// é‡ç½®è¿›åº¦æ¡
function resetProgress() {
    const steps = document.querySelectorAll('.step');
    steps.forEach(step => {
        step.className = 'step';
    });
    updateProgress(0);
}

// æ›´æ–°è¿›åº¦æ­¥éª¤
function updateProgressStep(step, status) {
    const stepEl = document.querySelector(`[data-step="${step}"]`);
    stepEl.className = `step ${status}`;
}

// æ›´æ–°è¿›åº¦æ¡
function updateProgress(percentage) {
    const fill = document.querySelector('.progress-fill');
    const text = document.querySelector('.progress-percentage');
    
    fill.style.width = percentage + '%';
    text.textContent = Math.round(percentage) + '%';
}

// è·å–æ­¥éª¤åç§°
function getStepName(step) {
    const names = {
        'text': 'æ–‡æ¡ˆç”Ÿæˆ',
        'image': 'å›¾åƒç”Ÿæˆ', 
        'audio': 'éŸ³é¢‘ç”Ÿæˆ',
        'video': 'è§†é¢‘åˆæˆ'
    };
    return names[step] || step;
}

// æ·»åŠ æ—¥å¿—
function addLog(level, message) {
    const container = document.getElementById('log-container');
    const time = new Date().toLocaleTimeString();
    
    const entry = document.createElement('div');
    entry.className = `log-entry ${level}`;
    entry.innerHTML = `
        <span class="log-time">[${time}]</span>
        <span class="log-level">[${level.toUpperCase()}]</span>
        <span class="log-message">${message}</span>
    `;
    
    container.appendChild(entry);
    container.scrollTop = container.scrollHeight;
}

// æ¸…ç©ºæ—¥å¿—
function clearLog() {
    const container = document.getElementById('log-container');
    container.innerHTML = '';
    
    // é‡ç½®æ—¶é—´æˆ³ï¼Œé‡æ–°è·å–æ—¥å¿—
    lastLogTimestamp = 0;
    
    addCustomLog('info', 'æ—¥å¿—æ˜¾ç¤ºå·²æ¸…ç©º');
}

// å¯¼å‡ºæ—¥å¿—
function exportLog() {
    // è·å–å½“å‰æ˜¾ç¤ºçš„æ‰€æœ‰æ—¥å¿—
    const container = document.getElementById('log-container');
    const logEntries = container.querySelectorAll('.log-entry');
    
    let logText = '=== AutoMovie Djangoæ—¥å¿—å¯¼å‡º ===\n';
    logText += `å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n`;
    logText += `æ€»è®¡æ—¥å¿—æ¡ç›®: ${logEntries.length}\n\n`;
    
    logEntries.forEach(entry => {
        const time = entry.querySelector('.log-time').textContent;
        const level = entry.querySelector('.log-level').textContent;
        const message = entry.querySelector('.log-message').textContent;
        logText += `${time} ${level} ${message}\n`;
    });
    
    // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
    const blob = new Blob([logText], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `django-log-${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    URL.revokeObjectURL(url);
    addCustomLog('info', 'Djangoæ—¥å¿—å·²å¯¼å‡ºåˆ°æ–‡ä»¶');
}

// åŠ è½½ç”Ÿæˆå†å²
function loadGenerationHistory() {
    const container = document.getElementById('history-container');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    container.innerHTML = `
        <div class="history-loading">
            <div class="history-loading-spinner"></div>
            æ­£åœ¨åŠ è½½ç”Ÿæˆå†å²...
        </div>
    `;
    
    addLog('info', 'æ­£åœ¨åŠ è½½ç”Ÿæˆå†å²...');
    
    fetch('/get_video_history/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayVideoHistory(data.videos, data.count);
                addLog('info', `æˆåŠŸåŠ è½½ ${data.count} ä¸ªå†å²è§†é¢‘`);
            } else {
                container.innerHTML = `
                    <div class="history-empty">
                        <div class="empty-icon">âŒ</div>
                        <div class="empty-text">åŠ è½½å¤±è´¥</div>
                        <div class="empty-subtitle">${data.error || 'æœªçŸ¥é”™è¯¯'}</div>
                    </div>
                `;
                addLog('error', 'åŠ è½½ç”Ÿæˆå†å²å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            container.innerHTML = `
                <div class="history-empty">
                    <div class="empty-icon">âŒ</div>
                    <div class="empty-text">ç½‘ç»œé”™è¯¯</div>
                    <div class="empty-subtitle">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</div>
                </div>
            `;
            addLog('error', 'åŠ è½½ç”Ÿæˆå†å²æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
        });
}

// æ˜¾ç¤ºè§†é¢‘å†å²
function displayVideoHistory(videos, count) {
    const container = document.getElementById('history-container');
    
    if (!videos || videos.length === 0) {
        container.innerHTML = `
            <div class="history-empty">
                <div class="empty-icon">ğŸ“</div>
                <div class="empty-text">æš‚æ— ç”Ÿæˆå†å²</div>
                <div class="empty-subtitle">å®Œæˆç¬¬ä¸€æ¬¡è‡ªåŠ¨ç”Ÿæˆåï¼Œå†å²è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    videos.forEach(video => {
        html += `
            <div class="history-item" data-video-path="${video.file_path}">
                <div class="history-item-icon">ğŸ¬</div>
                <div class="history-item-content">
                    <div class="history-item-title">${video.project_name}</div>
                    <div class="history-item-info">
                        <span class="history-item-time">ğŸ“… ${video.formatted_time}</span>
                        <span class="history-item-size">ğŸ’¾ ${video.formatted_size}</span>
                        <span class="history-item-path">ğŸ“ ${video.relative_path}</span>
                    </div>
                </div>
                <div class="history-item-actions">
                    <button class="history-action-btn history-play-btn" onclick="playVideo('${video.relative_path}', '${video.project_name}')">
                        â–¶ï¸ æ’­æ”¾
                    </button>
                    <button class="history-action-btn history-delete-btn" onclick="deleteVideo('${video.file_path}', '${video.project_name}')">
                        ğŸ—‘ï¸ åˆ é™¤
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// æ’­æ”¾è§†é¢‘
function playVideo(relativePath, projectName) {
    const modal = document.getElementById('video-modal');
    const player = document.getElementById('video-player');
    const title = document.getElementById('video-modal-title');
    
    // ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„ç›¸å¯¹è·¯å¾„æ„é€ åª’ä½“URL
    const mediaUrl = `/media/${relativePath}`;
    
    // è®¾ç½®è§†é¢‘æºå’Œæ ‡é¢˜
    player.src = mediaUrl;
    title.textContent = `æ’­æ”¾è§†é¢‘ - ${projectName}`;
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    modal.style.display = 'block';
    
    // æ’­æ”¾è§†é¢‘
    player.load();
    player.play().catch(error => {
        addLog('error', 'è§†é¢‘æ’­æ”¾å¤±è´¥: ' + error.message);
        console.error('è§†é¢‘æ’­æ”¾é”™è¯¯è¯¦æƒ…:', error);
        console.log('å°è¯•æ’­æ”¾çš„è§†é¢‘URL:', mediaUrl);
        console.log('ç›¸å¯¹è·¯å¾„:', relativePath);
    });
    
    addLog('info', `å¼€å§‹æ’­æ”¾è§†é¢‘: ${projectName}`);
    console.log('è§†é¢‘URL:', mediaUrl);
}

// åˆ é™¤è§†é¢‘
function deleteVideo(filePath, projectName) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤è§†é¢‘ "${projectName}" å—ï¼Ÿ\n\næ–‡ä»¶è·¯å¾„: ${filePath}\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
        return;
    }
    
    addLog('info', `æ­£åœ¨åˆ é™¤è§†é¢‘: ${projectName}`);
    
    fetch('/delete_video/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            file_path: filePath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addLog('success', `è§†é¢‘åˆ é™¤æˆåŠŸ: ${projectName}`);
            // é‡æ–°åŠ è½½å†å²è®°å½•
            loadGenerationHistory();
        } else {
            addLog('error', `åˆ é™¤è§†é¢‘å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
        }
    })
    .catch(error => {
        addLog('error', `åˆ é™¤è§†é¢‘æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`);
    });
}

// æ¸…ç©ºå†å²
function clearHistory() {
    if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç”Ÿæˆå†å²å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤ projects ç›®å½•ä¸‹çš„æ‰€æœ‰ MP4 æ–‡ä»¶ï¼\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
        return;
    }
    
    addLog('info', 'æ­£åœ¨æ¸…ç©ºç”Ÿæˆå†å²...');
    
    fetch('/clear_video_history/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addLog('success', `æˆåŠŸæ¸…ç©ºå†å²è®°å½•ï¼Œåˆ é™¤äº† ${data.deleted_count} ä¸ªè§†é¢‘æ–‡ä»¶`);
            // é‡æ–°åŠ è½½å†å²è®°å½•
            loadGenerationHistory();
        } else {
            addLog('error', `æ¸…ç©ºå†å²è®°å½•å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
        }
    })
    .catch(error => {
        addLog('error', `æ¸…ç©ºå†å²è®°å½•æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`);
    });
}

// åˆå§‹åŒ–è§†é¢‘æ¨¡æ€æ¡†äº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('video-modal');
    const closeBtn = document.getElementById('video-modal-close');
    const player = document.getElementById('video-player');
    
    // å…³é—­æ¨¡æ€æ¡†
    closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
        player.pause();
        player.src = '';
    });
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
            player.pause();
            player.src = '';
        }
    });
    
    // ESCé”®å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.style.display === 'block') {
            modal.style.display = 'none';
            player.pause();
            player.src = '';
        }
    });
});

// ç”Ÿæˆæ¬¡æ•°è®¾ç½®ç›¸å…³å‡½æ•°
function saveGenerationCountSettings() {
    const countInput = document.getElementById('generation-count');
    
    if (!countInput) {
        addLog('warning', 'ç”Ÿæˆæ¬¡æ•°è¾“å…¥æ¡†æœªæ‰¾åˆ°ï¼Œæ— æ³•ä¿å­˜è®¾ç½®');
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨åŠ è½½è®¾ç½®ï¼Œé¿å…åœ¨åŠ è½½æœŸé—´ä¿å­˜
    if (countInput.hasAttribute('data-loading')) {
        return;
    }
    
    let count = parseInt(countInput.value);
    
    // éªŒè¯è¾“å…¥å€¼
    if (isNaN(count) || count < 1 || count > 100) {
        // å¦‚æœè¾“å…¥æ— æ•ˆï¼Œæ¢å¤åˆ°é…ç½®æ–‡ä»¶ä¸­çš„å€¼
        const configValue = countInput.getAttribute('data-config-value');
        if (configValue) {
            count = parseInt(configValue);
            countInput.value = count;
        } else {
            count = 1; // é»˜è®¤å€¼
            countInput.value = count;
        }
        addLog('warning', `è¾“å…¥å€¼æ— æ•ˆï¼Œå·²æ¢å¤ä¸º ${count}`);
    }
    
    const data = {
        generation_count: count
    };
    
    fetch('/save_continuous_generation_settings/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addLog('info', `ç”Ÿæˆæ¬¡æ•°è®¾ç½®å·²ä¿å­˜åˆ°é…ç½®æ–‡ä»¶: ${count} æ¬¡`);
            // æ›´æ–°æ•°æ®å±æ€§
            countInput.setAttribute('data-config-value', count);
        } else {
            addLog('error', 'ä¿å­˜ç”Ÿæˆæ¬¡æ•°è®¾ç½®å¤±è´¥: ' + data.error);
        }
    })
    .catch(error => {
        addLog('error', 'ä¿å­˜ç”Ÿæˆæ¬¡æ•°è®¾ç½®æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
    });
}

function loadGenerationCountSettings() {
    const countInput = document.getElementById('generation-count');
    
    if (!countInput) {
        addLog('warning', 'ç”Ÿæˆæ¬¡æ•°è¾“å…¥æ¡†æœªæ‰¾åˆ°ï¼Œæ— æ³•åŠ è½½è®¾ç½®');
        return;
    }
    
    // è®¾ç½®åŠ è½½æ ‡è®°ï¼Œé˜²æ­¢åœ¨åŠ è½½æœŸé—´è§¦å‘ä¿å­˜
    countInput.setAttribute('data-loading', 'true');
    
    fetch('/load_continuous_generation_settings/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // è®¾ç½®ç”Ÿæˆæ¬¡æ•°ï¼Œç¡®ä¿ä½¿ç”¨ä»config.iniè¯»å–çš„å€¼
                const configCount = data.generation_count || 1;
                countInput.value = configCount;
                
                // é˜²æ­¢å…¶ä»–ä»£ç è¦†ç›–è¿™ä¸ªå€¼ï¼Œæ·»åŠ æ•°æ®å±æ€§æ ‡è®°
                countInput.setAttribute('data-config-value', configCount);
                
                if (configCount > 1) {
                    addLog('info', `å·²åŠ è½½ç”Ÿæˆæ¬¡æ•°è®¾ç½®ï¼š${configCount} æ¬¡ï¼ˆè¿ç»­ç”Ÿæˆæ¨¡å¼ï¼‰`);
                } else {
                    addLog('info', `å·²åŠ è½½ç”Ÿæˆæ¬¡æ•°è®¾ç½®ï¼š${configCount} æ¬¡ï¼ˆå•æ¬¡ç”Ÿæˆæ¨¡å¼ï¼‰`);
                }
            } else {
                addLog('warning', 'åŠ è½½ç”Ÿæˆæ¬¡æ•°è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            addLog('warning', 'åŠ è½½ç”Ÿæˆæ¬¡æ•°è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼: ' + error.message);
        })
        .finally(() => {
            // ç§»é™¤åŠ è½½æ ‡è®°
            countInput.removeAttribute('data-loading');
        });
}

// è·å–CSRF Token
function getCsrfToken() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    return '';
}
</script>
{% endblock %}