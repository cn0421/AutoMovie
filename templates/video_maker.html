{% extends 'base.html' %}

{% block title %}è§†é¢‘æ‹¼æ¥ - AutoMovie{% endblock %}

{% block page_title %}è§†é¢‘æ‹¼æ¥{% endblock %}
{% block page_description %}è§†é¢‘æ‹¼æ¥åŠŸèƒ½ï¼ˆMoviePyå·²å¼ƒç”¨ï¼Œç­‰å¾…FFMPEGå®ç°ï¼‰{% endblock %}

{% block content %}
<div class="video-maker">
    <!-- é¡¹ç›®ç´ ææ€»è§ˆ -->
    <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3>ğŸ“ é¡¹ç›®ç´ ææ€»è§ˆ</h3>
        
        <div style="margin-top: 15px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <!-- æ–‡æ¡ˆç´ æ -->
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: white;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 20px;">ğŸ“</span>
                        <h4 style="margin: 0;">æ–‡æ¡ˆç´ æ</h4>
                        {% if project_data.text_data.sentence_count > 0 %}
                            <span style="background-color: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">âœ“ å·²å®Œæˆ</span>
                        {% else %}
                            <span style="background-color: #6c757d; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">æœªç”Ÿæˆ</span>
                        {% endif %}
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        <div>åˆ†æ®µæ•°é‡ï¼š{{ project_data.text_data.sentence_count }}æ®µ</div>
                        <div>æ–‡æ¡ˆæ ‡é¢˜ï¼š{{ project_data.text_data.title }}</div>
                        <div>ç”Ÿæˆæ—¶é—´ï¼š{{ project_data.text_data.generated_time }}</div>
                    </div>
                    <a href="{% url 'text_generation' %}" class="btn" style="font-size: 12px; padding: 5px 10px; margin-top: 10px; text-decoration: none;">ğŸ“– æŸ¥çœ‹è¯¦æƒ…</a>
                </div>
                
                <!-- å›¾åƒç´ æ -->
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: white;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 20px;">ğŸ–¼ï¸</span>
                        <h4 style="margin: 0;">å›¾åƒç´ æ</h4>
                        {% if project_data.image_data.count > 0 %}
                            <span style="background-color: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">âœ“ å·²å®Œæˆ</span>
                        {% else %}
                            <span style="background-color: #6c757d; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">æœªç”Ÿæˆ</span>
                        {% endif %}
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        <div>å›¾ç‰‡æ•°é‡ï¼š{{ project_data.image_data.count }}å¼ </div>
                        <div>åˆ†è¾¨ç‡ï¼š1920x1080</div>
                        <div>æ ¼å¼ï¼š{{ project_data.image_data.format }}</div>
                    </div>
                    <a href="{% url 'image_generation' %}" class="btn" style="font-size: 12px; padding: 5px 10px; margin-top: 10px; text-decoration: none;">ğŸ–¼ï¸ é¢„è§ˆå›¾ç‰‡</a>
                </div>
                
                <!-- éŸ³é¢‘ç´ æ -->
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: white;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 20px;">ğŸµ</span>
                        <h4 style="margin: 0;">éŸ³é¢‘ç´ æ</h4>
                        {% if project_data.audio_data.count > 0 %}
                            <span style="background-color: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">âœ“ å·²å®Œæˆ</span>
                        {% else %}
                            <span style="background-color: #6c757d; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">æœªç”Ÿæˆ</span>
                        {% endif %}
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        <div>è¯­éŸ³ç‰‡æ®µï¼š{{ project_data.audio_data.count }}ä¸ª</div>
                        <div>æ ¼å¼ï¼š{{ project_data.audio_data.format }}</div>
                        <div>æ€»æ—¶é•¿ï¼š{{ project_data.audio_data.total_duration }}ç§’</div>
                    </div>
                    <a href="{% url 'audio_generation' %}" class="btn" style="font-size: 12px; padding: 5px 10px; margin-top: 10px; text-decoration: none;">ğŸ§ è¯•å¬éŸ³é¢‘</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è§†é¢‘ç”Ÿæˆè®¾ç½® -->
    <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3>ğŸ¬ è§†é¢‘ç”Ÿæˆè®¾ç½®</h3>
        
        <div style="margin-top: 15px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <!-- å­—å¹•è®¾ç½® -->
                <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                    <h4 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">ğŸ“</span>
                        å­—å¹•è®¾ç½®
                    </h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å­—ä½“é€‰æ‹©ï¼š</label>
                        <select id="subtitle-font" name="subtitle_font" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            {% for font in available_fonts %}
                                <option value="{{ font.filename }}" {% if font.filename == video_settings.subtitle.font %}selected{% endif %}>
                                    {{ font.name }}
                                </option>
                            {% empty %}
                                <option value="SourceHanSansCN-Regular.otf">æ€æºé»‘ä½“ (é»˜è®¤)</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">å­—ä½“å¤§å°ï¼š</label>
                            <input id="subtitle-size" name="subtitle_size" type="number" value="{{ video_settings.subtitle.size }}" min="12" max="72" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">å­—ä½“é¢œè‰²ï¼š</label>
                            <input id="subtitle-color" name="subtitle_color" type="color" value="{{ video_settings.subtitle.color }}" style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; height: 40px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å­—å¹•ä½ç½®ï¼š</label>
                        <select id="subtitle-position" name="subtitle_position" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="bottom-quarter" {% if video_settings.subtitle.position == 'bottom-quarter' %}selected{% endif %}>åº•éƒ¨1/4å¤„</option>
                            <option value="bottom-center" {% if video_settings.subtitle.position == 'bottom-center' %}selected{% endif %}>åº•éƒ¨å±…ä¸­</option>
                            <option value="bottom-left" {% if video_settings.subtitle.position == 'bottom-left' %}selected{% endif %}>åº•éƒ¨å·¦å¯¹é½</option>
                            <option value="bottom-right" {% if video_settings.subtitle.position == 'bottom-right' %}selected{% endif %}>åº•éƒ¨å³å¯¹é½</option>
                            <option value="center" {% if video_settings.subtitle.position == 'center' %}selected{% endif %}>å±å¹•ä¸­å¤®</option>
                            <option value="top-center" {% if video_settings.subtitle.position == 'top-center' %}selected{% endif %}>é¡¶éƒ¨å±…ä¸­</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ°´å¹³å¯¹é½ï¼š</label>
                        <select id="subtitle-horizontal-align" name="subtitle_horizontal_align" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="left" {% if video_settings.subtitle.horizontal_align == 'left' %}selected{% endif %}>å·¦å¯¹é½</option>
                            <option value="center" {% if video_settings.subtitle.horizontal_align == 'center' %}selected{% endif %}>å±…ä¸­å¯¹é½</option>
                            <option value="right" {% if video_settings.subtitle.horizontal_align == 'right' %}selected{% endif %}>å³å¯¹é½</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æè¾¹å®½åº¦ï¼š</label>
                            <input id="subtitle-stroke-width" name="subtitle_stroke_width" type="number" value="{{ video_settings.subtitle.stroke_width }}" min="0" max="10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æè¾¹é¢œè‰²ï¼š</label>
                            <input id="subtitle-stroke-color" name="subtitle_stroke_color" type="color" value="{{ video_settings.subtitle.stroke_color }}" style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; height: 40px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input id="subtitle-shadow" name="subtitle_shadow" type="checkbox" {% if video_settings.subtitle.shadow %}checked{% endif %}>
                            <span>å¯ç”¨å­—å¹•é˜´å½±æ•ˆæœ</span>
                        </label>
                    </div>
                    
                    <button id="save-subtitle-settings" class="btn" style="background-color: #28a745; font-size: 12px; padding: 8px 15px;">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                </div>
                
                <!-- æ·¡å…¥æ·¡å‡ºè®¾ç½® -->
                <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                    <h4 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">ğŸ­</span>
                        æ·¡å…¥æ·¡å‡ºè®¾ç½®
                    </h4>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ·¡å…¥å¸§æ•°ï¼š</label>
                            <input id="fade-in-frames" name="fade_in_frames" type="number" value="4" min="0" max="30" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">è§†é¢‘å¼€å§‹æ—¶çš„æ·¡å…¥å¸§æ•°</div>
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ·¡å‡ºå¸§æ•°ï¼š</label>
                            <input id="fade-out-frames" name="fade_out_frames" type="number" value="4" min="0" max="30" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">è§†é¢‘ç»“æŸæ—¶çš„æ·¡å‡ºå¸§æ•°</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å¸§ç‡ (FPS)ï¼š</label>
                        <select id="video-fps" name="video_fps" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="24">24 FPS (ç”µå½±æ ‡å‡†)</option>
                            <option value="25" selected>25 FPS (PALæ ‡å‡†)</option>
                            <option value="30">30 FPS (NTSCæ ‡å‡†)</option>
                            <option value="60">60 FPS (é«˜å¸§ç‡)</option>
                        </select>
                        <div style="font-size: 11px; color: #666; margin-top: 3px;">ç”¨äºè®¡ç®—è§†é¢‘æ€»å¸§æ•°</div>
                    </div>
                    
                    <button id="save-fade-settings" class="btn" style="background-color: #28a745; font-size: 12px; padding: 8px 15px;">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr; gap: 30px; margin-top: 30px;">
                <!-- èƒŒæ™¯éŸ³ä¹è®¾ç½® -->
                <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                    <h4 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">ğŸ¼</span>
                        èƒŒæ™¯éŸ³ä¹è®¾ç½®
                    </h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">éŸ³ä¹æ–‡ä»¶ï¼š</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="background-music" name="background_music" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">é€‰æ‹©èƒŒæ™¯éŸ³ä¹</option>
                                {% for music in available_music %}
                                    <option value="{{ music.filename }}" {% if music.filename == video_settings.background_music.file %}selected{% endif %}>
                                        {{ music.name }}
                                    </option>
                                {% empty %}
                                    <option value="default.mp3">é»˜è®¤èƒŒæ™¯éŸ³ä¹</option>
                                {% endfor %}
                                <option value="custom">ä¸Šä¼ è‡ªå®šä¹‰éŸ³ä¹</option>
                            </select>
                            <button class="btn" style="font-size: 12px; padding: 8px 12px;">ğŸ“ æµè§ˆ</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">éŸ³é‡ (%)ï¼š</label>
                            <input id="music-volume" name="music_volume" type="range" min="0" max="100" value="{{ video_settings.background_music.volume }}" style="width: 100%; margin-bottom: 5px;">
                            <div id="music-volume-display" style="text-align: center; font-size: 12px; color: #666;">{{ video_settings.background_music.volume }}%</div>
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ·¡å…¥æ—¶é—´ (ç§’)ï¼š</label>
                            <input id="music-fadein" name="music_fadein" type="number" value="{{ video_settings.background_music.fade_in }}" min="0" max="10" step="0.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ·¡å‡ºæ—¶é—´ (ç§’)ï¼š</label>
                            <input id="music-fadeout" name="music_fadeout" type="number" value="{{ video_settings.background_music.fade_out }}" min="0" max="10" step="0.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">å¾ªç¯æ¨¡å¼ï¼š</label>
                            <select id="music-loop" name="music_loop" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                 <option value="loop" {% if video_settings.background_music.loop_mode == 'loop' %}selected{% endif %}>å¾ªç¯æ’­æ”¾</option>
                                 <option value="once" {% if video_settings.background_music.loop_mode == 'once' %}selected{% endif %}>æ’­æ”¾ä¸€æ¬¡</option>
                                 <option value="fade" {% if video_settings.background_music.loop_mode == 'fade' %}selected{% endif %}>æ¸å˜å¾ªç¯</option>
                             </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input id="music-auto-adjust" name="music_auto_adjust" type="checkbox" {% if video_settings.background_music.auto_adjust %}checked{% endif %}>
                            <span>è‡ªåŠ¨è°ƒæ•´éŸ³ä¹é•¿åº¦åŒ¹é…è§†é¢‘</span>
                        </label>
                    </div>
                    
                    <button id="save-music-settings" class="btn" style="background-color: #28a745; font-size: 12px; padding: 8px 15px;">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>
    </div>
    
    





    <!-- è¾“å‡ºè®¾ç½® -->
    <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3>âš™ï¸ è¾“å‡ºè®¾ç½®</h3>
        
        <div style="margin-top: 15px;">
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <div style="flex: 1;">
                    <label for="output-resolution" style="display: block; margin-bottom: 5px; font-weight: bold;">è¾“å‡ºåˆ†è¾¨ç‡ï¼š</label>
                    <select id="output-resolution" name="output_resolution" 
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="1080x1920" selected>1080x1920 (æ‰‹æœºç«–å±)</option>
                        <option value="1920x1080">1920x1080 (æ¨ªå±é«˜æ¸…)</option>
                        <option value="720x1280">720x1280 (æ‰‹æœºç«–å±æ ‡æ¸…)</option>
                        <option value="1280x720">1280x720 (æ¨ªå±æ ‡æ¸…)</option>
                        <option value="1080x1080">1080x1080 (æ­£æ–¹å½¢)</option>
                        <option value="custom">è‡ªå®šä¹‰åˆ†è¾¨ç‡</option>
                    </select>
                    
                    <!-- è‡ªå®šä¹‰åˆ†è¾¨ç‡è¾“å…¥æ¡† -->
                    <div id="custom-resolution-inputs" style="display: none; margin-top: 10px; gap: 10px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="custom-width" placeholder="å®½åº¦" min="480" max="4096" 
                                   style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                            <span>Ã—</span>
                            <input type="number" id="custom-height" placeholder="é«˜åº¦" min="480" max="4096" 
                                   style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>
                
                <div style="flex: 1;">
                    <label for="output-quality" style="display: block; margin-bottom: 5px; font-weight: bold;">è¾“å‡ºè´¨é‡ï¼š</label>
                    <select id="output-quality" name="output_quality" 
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="high">é«˜è´¨é‡ (é«˜ç ç‡ï¼Œæ–‡ä»¶è¾ƒå¤§)</option>
                        <option value="medium" selected>ä¸­ç­‰è´¨é‡ (å¹³è¡¡è´¨é‡ä¸å¤§å°)</option>
                        <option value="low">ä½è´¨é‡ (å°æ–‡ä»¶ï¼Œè´¨é‡ä¸€èˆ¬)</option>
                        <option value="custom">è‡ªå®šä¹‰è´¨é‡</option>
                    </select>
                    
                    <!-- è‡ªå®šä¹‰è´¨é‡è®¾ç½® -->
                    <div id="custom-quality-inputs" style="display: none; margin-top: 10px;">
                        <div style="margin-bottom: 8px;">
                            <label style="display: block; font-size: 12px; margin-bottom: 3px;">è§†é¢‘ç ç‡ (kbps)ï¼š</label>
                            <input type="number" id="video-bitrate" value="5000" min="1000" max="20000" 
                                   style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; margin-bottom: 3px;">éŸ³é¢‘ç ç‡ (kbps)ï¼š</label>
                            <input type="number" id="audio-bitrate" value="192" min="64" max="320" 
                                   style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        </div>
                    </div>
                </div>
                
                <div style="flex: 1;">
                    <label for="output-name" style="display: block; margin-bottom: 5px; font-weight: bold;">æ–‡ä»¶åï¼š</label>
                    <input type="text" id="output-name" name="output_name" value="" placeholder="è‡ªåŠ¨ç”Ÿæˆæ—¶é—´æˆ³æ–‡ä»¶å" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <div style="font-size: 11px; color: #666; margin-top: 3px;">ç•™ç©ºå°†è‡ªåŠ¨ç”ŸæˆåŸºäºæ—¶é—´çš„æ–‡ä»¶å</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç”Ÿæˆæ§åˆ¶ -->
    <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3>ğŸš€ å¼€å§‹ç”Ÿæˆ</h3>
        
        <div style="margin-top: 15px;">
            <!-- ç”ŸæˆæŒ‰é’® -->
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <button id="generate-video" class="btn" style="background-color: #28a745; font-size: 16px; padding: 12px 24px;">
                    ğŸ¬ å¼€å§‹ç”Ÿæˆè§†é¢‘
                </button>

            </div>
        </div>
    </div>
</div>

<script>
// åŠ¨æ€æ›´æ–°éŸ³é‡æ˜¾ç¤º
document.getElementById('music-volume').addEventListener('input', function() {
    document.getElementById('music-volume-display').textContent = this.value + '%';
});

// ä¿å­˜å­—å¹•è®¾ç½®åŠŸèƒ½
document.getElementById('save-subtitle-settings').addEventListener('click', function() {
    // æ”¶é›†å­—å¹•è®¾ç½®
    const subtitleSettings = {
        font: document.getElementById('subtitle-font').value,
        size: parseInt(document.getElementById('subtitle-size').value),
        color: document.getElementById('subtitle-color').value,
        position: document.getElementById('subtitle-position').value,
        horizontal_align: document.getElementById('subtitle-horizontal-align').value,
        stroke_width: parseInt(document.getElementById('subtitle-stroke-width').value),
        stroke_color: document.getElementById('subtitle-stroke-color').value,
        shadow: document.getElementById('subtitle-shadow').checked
    };
    
    // å‡†å¤‡å‘é€çš„æ•°æ®
    const settingsData = {
        subtitle: subtitleSettings
    };
    
    // å‘é€AJAXè¯·æ±‚ä¿å­˜è®¾ç½®
    fetch('/save_video_settings/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(settingsData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('å­—å¹•è®¾ç½®ä¿å­˜æˆåŠŸ');
        } else {
            alert('ä¿å­˜å¤±è´¥ï¼š' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ä¿å­˜å­—å¹•è®¾ç½®æ—¶å‘ç”Ÿé”™è¯¯');
    });
});

// ä¿å­˜èƒŒæ™¯éŸ³ä¹è®¾ç½®åŠŸèƒ½
document.getElementById('save-music-settings').addEventListener('click', function() {
    // æ”¶é›†èƒŒæ™¯éŸ³ä¹è®¾ç½®
    const backgroundMusicSettings = {
        file: document.getElementById('background-music').value,
        volume: parseInt(document.getElementById('music-volume').value),
        fade_in: parseFloat(document.getElementById('music-fadein').value),
        fade_out: parseFloat(document.getElementById('music-fadeout').value),
        loop_mode: document.getElementById('music-loop').value,
        auto_adjust: document.getElementById('music-auto-adjust').checked
    };
    
    // å‡†å¤‡å‘é€çš„æ•°æ®
    const settingsData = {
        background_music: backgroundMusicSettings
    };
    
    // å‘é€AJAXè¯·æ±‚ä¿å­˜è®¾ç½®
    fetch('/save_video_settings/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(settingsData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('èƒŒæ™¯éŸ³ä¹è®¾ç½®ä¿å­˜æˆåŠŸ');
        } else {
            alert('ä¿å­˜å¤±è´¥ï¼š' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ä¿å­˜èƒŒæ™¯éŸ³ä¹è®¾ç½®æ—¶å‘ç”Ÿé”™è¯¯');
    });
});

// ä¿å­˜æ·¡å…¥æ·¡å‡ºè®¾ç½®åŠŸèƒ½
document.getElementById('save-fade-settings').addEventListener('click', function() {
    // æ”¶é›†æ·¡å…¥æ·¡å‡ºè®¾ç½®
    const fadeSettings = {
        fade_in_frames: parseInt(document.getElementById('fade-in-frames').value),
        fade_out_frames: parseInt(document.getElementById('fade-out-frames').value),
        video_fps: parseInt(document.getElementById('video-fps').value)
    };
    
    // å‡†å¤‡å‘é€çš„æ•°æ®
    const settingsData = {
        fade: fadeSettings
    };
    
    // å‘é€AJAXè¯·æ±‚ä¿å­˜è®¾ç½®
    fetch('/save_video_settings/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(settingsData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('æ·¡å…¥æ·¡å‡ºè®¾ç½®ä¿å­˜æˆåŠŸ');
            alert('æ·¡å…¥æ·¡å‡ºè®¾ç½®å·²ä¿å­˜');
        } else {
            alert('ä¿å­˜å¤±è´¥ï¼š' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ä¿å­˜æ·¡å…¥æ·¡å‡ºè®¾ç½®æ—¶å‘ç”Ÿé”™è¯¯');
    });
});

// è·å–CSRF Tokençš„è¾…åŠ©å‡½æ•°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

let currentProjectName = ''; // å½“å‰é¡¹ç›®åç§°

// è·å–å½“å‰é¡¹ç›®ä¿¡æ¯
function loadCurrentProjectInfo() {
    return fetch('/get_current_project/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.project) {
            // ä»é¡¹ç›®è·¯å¾„ä¸­æå–é¡¹ç›®åç§°
            const projectPath = data.project.project_path;
            currentProjectName = projectPath.split(/[\/\\]/).pop(); // è·å–è·¯å¾„çš„æœ€åä¸€éƒ¨åˆ†
            console.log('å½“å‰é¡¹ç›®åç§°:', currentProjectName);
            return true;
        } else {
            console.error('è·å–é¡¹ç›®ä¿¡æ¯å¤±è´¥:', data.error || 'æœªæ‰¾åˆ°é¡¹ç›®');
            return false;
        }
    })
    .catch(error => {
        console.error('è·å–é¡¹ç›®ä¿¡æ¯æ—¶å‡ºé”™:', error);
        return false;
    });
}

// ç”Ÿæˆè§†é¢‘å‡½æ•°
function generateVideo() {
    const generateBtn = document.getElementById('generate-video');
    const progressBar = document.querySelector('.progress-bar');
    const progressText = document.querySelector('.progress-text');
    const logContainer = document.querySelector('.log-container');
    
    // è·å–è¾“å‡ºè®¾ç½®
    const outputSettings = getOutputSettings();
    if (!outputSettings) {
        return; // å¦‚æœè®¾ç½®æ— æ•ˆï¼Œç›´æ¥è¿”å›
    }
    
    // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
    generateBtn.disabled = true;
    generateBtn.textContent = 'ğŸ¬ ç”Ÿæˆä¸­...';
    generateBtn.style.backgroundColor = '#6c757d';
    
    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
    updateProgress(0, 'å¼€å§‹ç”Ÿæˆè§†é¢‘...');
    addLog('[INFO] å¼€å§‹ç”Ÿæˆè§†é¢‘...');
    addLog(`[INFO] åˆ†è¾¨ç‡: ${outputSettings.resolution.width}x${outputSettings.resolution.height}`);
    addLog(`[INFO] è´¨é‡: ${outputSettings.quality.preset}`);
    addLog(`[INFO] æ–‡ä»¶å: ${outputSettings.filename}`);
    addLog('[INFO] æ­£åœ¨æ”¶é›†é¡¹ç›®ç´ æ...');
    
    // å‘é€ç”Ÿæˆè§†é¢‘è¯·æ±‚
    fetch('/generate_video/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            project_name: currentProjectName,
            resolution: outputSettings.resolution,
            quality: outputSettings.quality,
            filename: outputSettings.filename
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addLog('[SUCCESS] è§†é¢‘ç”ŸæˆæˆåŠŸ!');
            addLog(`[INFO] è§†é¢‘å·²ä¿å­˜åˆ°: ${data.video_path}`);
            updateProgress(100, 'ç”Ÿæˆå®Œæˆ!');
            
            // é‡ç½®æŒ‰é’®
            setTimeout(() => {
                generateBtn.disabled = false;
                generateBtn.textContent = 'ğŸ¬ å¼€å§‹ç”Ÿæˆè§†é¢‘';
                generateBtn.style.backgroundColor = '#28a745';
            }, 2000);
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            console.log(`è§†é¢‘ç”ŸæˆæˆåŠŸ! ä¿å­˜ä½ç½®: ${data.video_path}`);
        } else {
            addLog(`[ERROR] ç”Ÿæˆå¤±è´¥: ${data.error}`);
            updateProgress(0, 'ç”Ÿæˆå¤±è´¥');
            
            // é‡ç½®æŒ‰é’®
            generateBtn.disabled = false;
            generateBtn.textContent = 'ğŸ¬ å¼€å§‹ç”Ÿæˆè§†é¢‘';
            generateBtn.style.backgroundColor = '#28a745';
            
            alert(`è§†é¢‘ç”Ÿæˆå¤±è´¥: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('ç”Ÿæˆè§†é¢‘æ—¶å‡ºé”™:', error);
        addLog(`[ERROR] ç½‘ç»œé”™è¯¯: ${error.message}`);
        updateProgress(0, 'ç”Ÿæˆå¤±è´¥');
        
        // é‡ç½®æŒ‰é’®
        generateBtn.disabled = false;
        generateBtn.textContent = 'ğŸ¬ å¼€å§‹ç”Ÿæˆè§†é¢‘';
        generateBtn.style.backgroundColor = '#28a745';
        
        alert('ç”Ÿæˆè§†é¢‘æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    });
}

// æ›´æ–°è¿›åº¦æ¡
function updateProgress(percent, statusText) {
    const progressBar = document.querySelector('div[style*="background-color: #28a745"]');
    const statusSpan = document.querySelector('span[style*="color: #666"]:last-of-type');
    
    if (progressBar) {
        progressBar.style.width = percent + '%';
    }
    if (statusSpan) {
        statusSpan.textContent = statusText;
    }
}

// æ·»åŠ æ—¥å¿—
function addLog(message) {
    const logContainer = document.querySelector('div[style*="background-color: #000"]');
    if (logContainer) {
        const logEntry = document.createElement('div');
        const timestamp = new Date().toLocaleTimeString();
        logEntry.textContent = `[${timestamp}] ${message}`;
        
        // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®é¢œè‰²
        if (message.includes('[ERROR]')) {
            logEntry.style.color = '#ff6b6b';
        } else if (message.includes('[SUCCESS]')) {
            logEntry.style.color = '#51cf66';
        } else if (message.includes('[INFO]')) {
            logEntry.style.color = '#74c0fc';
        } else {
            logEntry.style.color = '#00ff00';
        }
        
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }
}

// ç”Ÿæˆé»˜è®¤æ–‡ä»¶å
function generateDefaultFilename() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hour = String(now.getHours()).padStart(2, '0');
    const minute = String(now.getMinutes()).padStart(2, '0');
    const second = String(now.getSeconds()).padStart(2, '0');
    
    return `video_${year}${month}${day}_${hour}${minute}${second}`;
}

// å¤„ç†åˆ†è¾¨ç‡é€‰æ‹©å˜åŒ–
function handleResolutionChange() {
    const resolutionSelect = document.getElementById('output-resolution');
    const customInputs = document.getElementById('custom-resolution-inputs');
    
    if (resolutionSelect.value === 'custom') {
        customInputs.style.display = 'block';
    } else {
        customInputs.style.display = 'none';
    }
}

// å¤„ç†è´¨é‡é€‰æ‹©å˜åŒ–
function handleQualityChange() {
    const qualitySelect = document.getElementById('output-quality');
    const customInputs = document.getElementById('custom-quality-inputs');
    
    if (qualitySelect.value === 'custom') {
        customInputs.style.display = 'block';
    } else {
        customInputs.style.display = 'none';
    }
}

// è·å–è¾“å‡ºè®¾ç½®
function getOutputSettings() {
    const resolutionSelect = document.getElementById('output-resolution');
    const qualitySelect = document.getElementById('output-quality');
    const filenameInput = document.getElementById('output-name');
    
    let resolution;
    if (resolutionSelect.value === 'custom') {
        const width = document.getElementById('custom-width').value;
        const height = document.getElementById('custom-height').value;
        if (width && height) {
            resolution = { width: parseInt(width), height: parseInt(height) };
        } else {
            alert('è¯·è¾“å…¥è‡ªå®šä¹‰åˆ†è¾¨ç‡çš„å®½åº¦å’Œé«˜åº¦');
            return null;
        }
    } else {
        const [width, height] = resolutionSelect.value.split('x').map(Number);
        resolution = { width, height };
    }
    
    let quality = { preset: qualitySelect.value };
    if (qualitySelect.value === 'custom') {
        const videoBitrate = document.getElementById('video-bitrate').value;
        const audioBitrate = document.getElementById('audio-bitrate').value;
        if (videoBitrate && audioBitrate) {
            quality = {
                preset: 'custom',
                videoBitrate: parseInt(videoBitrate),
                audioBitrate: parseInt(audioBitrate)
            };
        } else {
            alert('è¯·è¾“å…¥è‡ªå®šä¹‰è´¨é‡çš„è§†é¢‘å’ŒéŸ³é¢‘ç ç‡');
            return null;
        }
    }
    
    let filename = filenameInput.value.trim();
    if (!filename) {
        filename = generateDefaultFilename();
    }
    
    return {
        resolution,
        quality,
        filename
    };
}

// åŠ è½½æ·¡å…¥æ·¡å‡ºè®¾ç½®
function loadVideoFadeSettings() {
    if (!currentProjectName) {
        console.warn('é¡¹ç›®åç§°æœªè®¾ç½®ï¼Œæ— æ³•åŠ è½½æ·¡å…¥æ·¡å‡ºè®¾ç½®');
        return;
    }
    
    fetch('/load_video_fade_settings/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            project_name: currentProjectName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ›´æ–°æ·¡å…¥æ·¡å‡ºè®¾ç½®è¾“å…¥æ¡†
            const fadeInInput = document.getElementById('fade-in-frames');
            const fadeOutInput = document.getElementById('fade-out-frames');
            const videoFpsInput = document.getElementById('video-fps');
            
            if (fadeInInput) fadeInInput.value = data.fade_in_frames;
            if (fadeOutInput) fadeOutInput.value = data.fade_out_frames;
            if (videoFpsInput) videoFpsInput.value = data.video_fps;
            
            console.log('æ·¡å…¥æ·¡å‡ºè®¾ç½®åŠ è½½æˆåŠŸ:', data);
        } else {
            console.warn('åŠ è½½æ·¡å…¥æ·¡å‡ºè®¾ç½®å¤±è´¥:', data.error);
        }
    })
    .catch(error => {
        console.error('åŠ è½½æ·¡å…¥æ·¡å‡ºè®¾ç½®æ—¶å‡ºé”™:', error);
    });
}

// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–éŸ³é‡æ˜¾ç¤º
    const volumeSlider = document.getElementById('music-volume');
    const volumeDisplay = document.getElementById('music-volume-display');
    if (volumeSlider && volumeDisplay) {
        volumeDisplay.textContent = volumeSlider.value + '%';
    }
    
    // åˆå§‹åŒ–é»˜è®¤æ–‡ä»¶å
    const filenameInput = document.getElementById('output-name');
    if (filenameInput && !filenameInput.value) {
        filenameInput.placeholder = generateDefaultFilename();
    }
    
    // åŠ è½½é¡¹ç›®ä¿¡æ¯
    loadCurrentProjectInfo().then(success => {
        if (success) {
            console.log('é¡¹ç›®ä¿¡æ¯åŠ è½½æˆåŠŸ');
            // åŠ è½½æ·¡å…¥æ·¡å‡ºè®¾ç½®
            loadVideoFadeSettings();
        } else {
            console.error('æ— æ³•åŠ è½½é¡¹ç›®ä¿¡æ¯');
        }
    });
    
    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    document.getElementById('generate-video').addEventListener('click', generateVideo);
    
    // ç»‘å®šè¾“å‡ºè®¾ç½®ç›¸å…³äº‹ä»¶
    document.getElementById('output-resolution').addEventListener('change', handleResolutionChange);
    document.getElementById('output-quality').addEventListener('change', handleQualityChange);
});
</script>

{% endblock %}