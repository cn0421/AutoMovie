{% extends 'base.html' %}

{% block title %}视频拼接 - AutoMovie{% endblock %}

{% block page_title %}视频拼接{% endblock %}
{% block page_description %}视频拼接功能（MoviePy已弃用，等待FFMPEG实现）{% endblock %}

{% block content %}
<div class="video-maker">
    <!-- 项目素材总览 -->
    <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3>📁 项目素材总览</h3>
        
        <div style="margin-top: 15px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <!-- 文案素材 -->
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: white;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 20px;">📝</span>
                        <h4 style="margin: 0;">文案素材</h4>
                        {% if project_data.text_data.sentence_count > 0 %}
                            <span style="background-color: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">✓ 已完成</span>
                        {% else %}
                            <span style="background-color: #6c757d; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">未生成</span>
                        {% endif %}
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        <div>分段数量：{{ project_data.text_data.sentence_count }}段</div>
                        <div>文案标题：{{ project_data.text_data.title }}</div>
                        <div>生成时间：{{ project_data.text_data.generated_time }}</div>
                    </div>
                    <a href="{% url 'text_generation' %}" class="btn" style="font-size: 12px; padding: 5px 10px; margin-top: 10px; text-decoration: none;">📖 查看详情</a>
                </div>
                
                <!-- 图像素材 -->
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: white;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 20px;">🖼️</span>
                        <h4 style="margin: 0;">图像素材</h4>
                        {% if project_data.image_data.count > 0 %}
                            <span style="background-color: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">✓ 已完成</span>
                        {% else %}
                            <span style="background-color: #6c757d; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">未生成</span>
                        {% endif %}
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        <div>图片数量：{{ project_data.image_data.count }}张</div>
                        <div>分辨率：1920x1080</div>
                        <div>格式：{{ project_data.image_data.format }}</div>
                    </div>
                    <a href="{% url 'image_generation' %}" class="btn" style="font-size: 12px; padding: 5px 10px; margin-top: 10px; text-decoration: none;">🖼️ 预览图片</a>
                </div>
                
                <!-- 音频素材 -->
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: white;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 20px;">🎵</span>
                        <h4 style="margin: 0;">音频素材</h4>
                        {% if project_data.audio_data.count > 0 %}
                            <span style="background-color: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">✓ 已完成</span>
                        {% else %}
                            <span style="background-color: #6c757d; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">未生成</span>
                        {% endif %}
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        <div>语音片段：{{ project_data.audio_data.count }}个</div>
                        <div>格式：{{ project_data.audio_data.format }}</div>
                        <div>总时长：{{ project_data.audio_data.total_duration }}秒</div>
                    </div>
                    <a href="{% url 'audio_generation' %}" class="btn" style="font-size: 12px; padding: 5px 10px; margin-top: 10px; text-decoration: none;">🎧 试听音频</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 视频生成设置 -->
    <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3>🎬 视频生成设置</h3>
        
        <div style="margin-top: 15px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <!-- 字幕设置 -->
                <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                    <h4 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">📝</span>
                        字幕设置
                    </h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">字体选择：</label>
                        <select id="subtitle-font" name="subtitle_font" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            {% for font in available_fonts %}
                                <option value="{{ font.filename }}" {% if font.filename == video_settings.subtitle.font %}selected{% endif %}>
                                    {{ font.name }}
                                </option>
                            {% empty %}
                                <option value="SourceHanSansCN-Regular.otf">思源黑体 (默认)</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">字体大小：</label>
                            <input id="subtitle-size" name="subtitle_size" type="number" value="{{ video_settings.subtitle.size }}" min="12" max="72" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">字体颜色：</label>
                            <input id="subtitle-color" name="subtitle_color" type="color" value="{{ video_settings.subtitle.color }}" style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; height: 40px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">字幕位置：</label>
                        <select id="subtitle-position" name="subtitle_position" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="bottom-quarter" {% if video_settings.subtitle.position == 'bottom-quarter' %}selected{% endif %}>底部1/4处</option>
                            <option value="bottom-center" {% if video_settings.subtitle.position == 'bottom-center' %}selected{% endif %}>底部居中</option>
                            <option value="bottom-left" {% if video_settings.subtitle.position == 'bottom-left' %}selected{% endif %}>底部左对齐</option>
                            <option value="bottom-right" {% if video_settings.subtitle.position == 'bottom-right' %}selected{% endif %}>底部右对齐</option>
                            <option value="center" {% if video_settings.subtitle.position == 'center' %}selected{% endif %}>屏幕中央</option>
                            <option value="top-center" {% if video_settings.subtitle.position == 'top-center' %}selected{% endif %}>顶部居中</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">水平对齐：</label>
                        <select id="subtitle-horizontal-align" name="subtitle_horizontal_align" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="left" {% if video_settings.subtitle.horizontal_align == 'left' %}selected{% endif %}>左对齐</option>
                            <option value="center" {% if video_settings.subtitle.horizontal_align == 'center' %}selected{% endif %}>居中对齐</option>
                            <option value="right" {% if video_settings.subtitle.horizontal_align == 'right' %}selected{% endif %}>右对齐</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">描边宽度：</label>
                            <input id="subtitle-stroke-width" name="subtitle_stroke_width" type="number" value="{{ video_settings.subtitle.stroke_width }}" min="0" max="10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">描边颜色：</label>
                            <input id="subtitle-stroke-color" name="subtitle_stroke_color" type="color" value="{{ video_settings.subtitle.stroke_color }}" style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; height: 40px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input id="subtitle-shadow" name="subtitle_shadow" type="checkbox" {% if video_settings.subtitle.shadow %}checked{% endif %}>
                            <span>启用字幕阴影效果</span>
                        </label>
                    </div>
                    
                    <button id="save-subtitle-settings" class="btn" style="background-color: #28a745; font-size: 12px; padding: 8px 15px;">💾 保存设置</button>
                </div>
                
                <!-- 淡入淡出设置 -->
                <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                    <h4 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">🎭</span>
                        淡入淡出设置
                    </h4>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">淡入帧数：</label>
                            <input id="fade-in-frames" name="fade_in_frames" type="number" value="4" min="0" max="30" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">视频开始时的淡入帧数</div>
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">淡出帧数：</label>
                            <input id="fade-out-frames" name="fade_out_frames" type="number" value="4" min="0" max="30" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">视频结束时的淡出帧数</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">帧率 (FPS)：</label>
                        <select id="video-fps" name="video_fps" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="24">24 FPS (电影标准)</option>
                            <option value="25" selected>25 FPS (PAL标准)</option>
                            <option value="30">30 FPS (NTSC标准)</option>
                            <option value="60">60 FPS (高帧率)</option>
                        </select>
                        <div style="font-size: 11px; color: #666; margin-top: 3px;">用于计算视频总帧数</div>
                    </div>
                    
                    <button id="save-fade-settings" class="btn" style="background-color: #28a745; font-size: 12px; padding: 8px 15px;">💾 保存设置</button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr; gap: 30px; margin-top: 30px;">
                <!-- 背景音乐设置 -->
                <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                    <h4 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">🎼</span>
                        背景音乐设置
                    </h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">音乐文件：</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="background-music" name="background_music" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">选择背景音乐</option>
                                {% for music in available_music %}
                                    <option value="{{ music.filename }}" {% if music.filename == video_settings.background_music.file %}selected{% endif %}>
                                        {{ music.name }}
                                    </option>
                                {% empty %}
                                    <option value="default.mp3">默认背景音乐</option>
                                {% endfor %}
                                <option value="custom">上传自定义音乐</option>
                            </select>
                            <button class="btn" style="font-size: 12px; padding: 8px 12px;">📁 浏览</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">音量 (%)：</label>
                            <input id="music-volume" name="music_volume" type="range" min="0" max="100" value="{{ video_settings.background_music.volume }}" style="width: 100%; margin-bottom: 5px;">
                            <div id="music-volume-display" style="text-align: center; font-size: 12px; color: #666;">{{ video_settings.background_music.volume }}%</div>
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">淡入时间 (秒)：</label>
                            <input id="music-fadein" name="music_fadein" type="number" value="{{ video_settings.background_music.fade_in }}" min="0" max="10" step="0.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">淡出时间 (秒)：</label>
                            <input id="music-fadeout" name="music_fadeout" type="number" value="{{ video_settings.background_music.fade_out }}" min="0" max="10" step="0.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">循环模式：</label>
                            <select id="music-loop" name="music_loop" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                 <option value="loop" {% if video_settings.background_music.loop_mode == 'loop' %}selected{% endif %}>循环播放</option>
                                 <option value="once" {% if video_settings.background_music.loop_mode == 'once' %}selected{% endif %}>播放一次</option>
                                 <option value="fade" {% if video_settings.background_music.loop_mode == 'fade' %}selected{% endif %}>渐变循环</option>
                             </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input id="music-auto-adjust" name="music_auto_adjust" type="checkbox" {% if video_settings.background_music.auto_adjust %}checked{% endif %}>
                            <span>自动调整音乐长度匹配视频</span>
                        </label>
                    </div>
                    
                    <button id="save-music-settings" class="btn" style="background-color: #28a745; font-size: 12px; padding: 8px 15px;">💾 保存设置</button>
                </div>
            </div>
        </div>
    </div>
    
    





    <!-- 输出设置 -->
    <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3>⚙️ 输出设置</h3>
        
        <div style="margin-top: 15px;">
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <div style="flex: 1;">
                    <label for="output-resolution" style="display: block; margin-bottom: 5px; font-weight: bold;">输出分辨率：</label>
                    <select id="output-resolution" name="output_resolution" 
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="1080x1920" selected>1080x1920 (手机竖屏)</option>
                        <option value="1920x1080">1920x1080 (横屏高清)</option>
                        <option value="720x1280">720x1280 (手机竖屏标清)</option>
                        <option value="1280x720">1280x720 (横屏标清)</option>
                        <option value="1080x1080">1080x1080 (正方形)</option>
                        <option value="custom">自定义分辨率</option>
                    </select>
                    
                    <!-- 自定义分辨率输入框 -->
                    <div id="custom-resolution-inputs" style="display: none; margin-top: 10px; gap: 10px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="custom-width" placeholder="宽度" min="480" max="4096" 
                                   style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                            <span>×</span>
                            <input type="number" id="custom-height" placeholder="高度" min="480" max="4096" 
                                   style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>
                
                <div style="flex: 1;">
                    <label for="output-quality" style="display: block; margin-bottom: 5px; font-weight: bold;">输出质量：</label>
                    <select id="output-quality" name="output_quality" 
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="high">高质量 (高码率，文件较大)</option>
                        <option value="medium" selected>中等质量 (平衡质量与大小)</option>
                        <option value="low">低质量 (小文件，质量一般)</option>
                        <option value="custom">自定义质量</option>
                    </select>
                    
                    <!-- 自定义质量设置 -->
                    <div id="custom-quality-inputs" style="display: none; margin-top: 10px;">
                        <div style="margin-bottom: 8px;">
                            <label style="display: block; font-size: 12px; margin-bottom: 3px;">视频码率 (kbps)：</label>
                            <input type="number" id="video-bitrate" value="5000" min="1000" max="20000" 
                                   style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; margin-bottom: 3px;">音频码率 (kbps)：</label>
                            <input type="number" id="audio-bitrate" value="192" min="64" max="320" 
                                   style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        </div>
                    </div>
                </div>
                
                <div style="flex: 1;">
                    <label for="output-name" style="display: block; margin-bottom: 5px; font-weight: bold;">文件名：</label>
                    <input type="text" id="output-name" name="output_name" value="" placeholder="自动生成时间戳文件名" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <div style="font-size: 11px; color: #666; margin-top: 3px;">留空将自动生成基于时间的文件名</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 生成控制 -->
    <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3>🚀 开始生成</h3>
        
        <div style="margin-top: 15px;">
            <!-- 生成按钮 -->
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <button id="generate-video" class="btn" style="background-color: #28a745; font-size: 16px; padding: 12px 24px;">
                    🎬 开始生成视频
                </button>

            </div>
        </div>
    </div>
</div>

<script>
// 动态更新音量显示
document.getElementById('music-volume').addEventListener('input', function() {
    document.getElementById('music-volume-display').textContent = this.value + '%';
});

// 保存字幕设置功能
document.getElementById('save-subtitle-settings').addEventListener('click', function() {
    // 收集字幕设置
    const subtitleSettings = {
        font: document.getElementById('subtitle-font').value,
        size: parseInt(document.getElementById('subtitle-size').value),
        color: document.getElementById('subtitle-color').value,
        position: document.getElementById('subtitle-position').value,
        horizontal_align: document.getElementById('subtitle-horizontal-align').value,
        stroke_width: parseInt(document.getElementById('subtitle-stroke-width').value),
        stroke_color: document.getElementById('subtitle-stroke-color').value,
        shadow: document.getElementById('subtitle-shadow').checked
    };
    
    // 准备发送的数据
    const settingsData = {
        subtitle: subtitleSettings
    };
    
    // 发送AJAX请求保存设置
    fetch('/save_video_settings/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(settingsData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('字幕设置保存成功');
        } else {
            alert('保存失败：' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('保存字幕设置时发生错误');
    });
});

// 保存背景音乐设置功能
document.getElementById('save-music-settings').addEventListener('click', function() {
    // 收集背景音乐设置
    const backgroundMusicSettings = {
        file: document.getElementById('background-music').value,
        volume: parseInt(document.getElementById('music-volume').value),
        fade_in: parseFloat(document.getElementById('music-fadein').value),
        fade_out: parseFloat(document.getElementById('music-fadeout').value),
        loop_mode: document.getElementById('music-loop').value,
        auto_adjust: document.getElementById('music-auto-adjust').checked
    };
    
    // 准备发送的数据
    const settingsData = {
        background_music: backgroundMusicSettings
    };
    
    // 发送AJAX请求保存设置
    fetch('/save_video_settings/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(settingsData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('背景音乐设置保存成功');
        } else {
            alert('保存失败：' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('保存背景音乐设置时发生错误');
    });
});

// 保存淡入淡出设置功能
document.getElementById('save-fade-settings').addEventListener('click', function() {
    // 收集淡入淡出设置
    const fadeSettings = {
        fade_in_frames: parseInt(document.getElementById('fade-in-frames').value),
        fade_out_frames: parseInt(document.getElementById('fade-out-frames').value),
        video_fps: parseInt(document.getElementById('video-fps').value)
    };
    
    // 准备发送的数据
    const settingsData = {
        fade: fadeSettings
    };
    
    // 发送AJAX请求保存设置
    fetch('/save_video_settings/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(settingsData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('淡入淡出设置保存成功');
            alert('淡入淡出设置已保存');
        } else {
            alert('保存失败：' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('保存淡入淡出设置时发生错误');
    });
});

// 获取CSRF Token的辅助函数
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

let currentProjectName = ''; // 当前项目名称

// 获取当前项目信息
function loadCurrentProjectInfo() {
    return fetch('/get_current_project/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.project) {
            // 从项目路径中提取项目名称
            const projectPath = data.project.project_path;
            currentProjectName = projectPath.split(/[\/\\]/).pop(); // 获取路径的最后一部分
            console.log('当前项目名称:', currentProjectName);
            return true;
        } else {
            console.error('获取项目信息失败:', data.error || '未找到项目');
            return false;
        }
    })
    .catch(error => {
        console.error('获取项目信息时出错:', error);
        return false;
    });
}

// 生成视频函数
function generateVideo() {
    const generateBtn = document.getElementById('generate-video');
    const progressBar = document.querySelector('.progress-bar');
    const progressText = document.querySelector('.progress-text');
    const logContainer = document.querySelector('.log-container');
    
    // 获取输出设置
    const outputSettings = getOutputSettings();
    if (!outputSettings) {
        return; // 如果设置无效，直接返回
    }
    
    // 禁用按钮，防止重复点击
    generateBtn.disabled = true;
    generateBtn.textContent = '🎬 生成中...';
    generateBtn.style.backgroundColor = '#6c757d';
    
    // 更新进度显示
    updateProgress(0, '开始生成视频...');
    addLog('[INFO] 开始生成视频...');
    addLog(`[INFO] 分辨率: ${outputSettings.resolution.width}x${outputSettings.resolution.height}`);
    addLog(`[INFO] 质量: ${outputSettings.quality.preset}`);
    addLog(`[INFO] 文件名: ${outputSettings.filename}`);
    addLog('[INFO] 正在收集项目素材...');
    
    // 发送生成视频请求
    fetch('/generate_video/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            project_name: currentProjectName,
            resolution: outputSettings.resolution,
            quality: outputSettings.quality,
            filename: outputSettings.filename
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addLog('[SUCCESS] 视频生成成功!');
            addLog(`[INFO] 视频已保存到: ${data.video_path}`);
            updateProgress(100, '生成完成!');
            
            // 重置按钮
            setTimeout(() => {
                generateBtn.disabled = false;
                generateBtn.textContent = '🎬 开始生成视频';
                generateBtn.style.backgroundColor = '#28a745';
            }, 2000);
            
            // 显示成功消息
            console.log(`视频生成成功! 保存位置: ${data.video_path}`);
        } else {
            addLog(`[ERROR] 生成失败: ${data.error}`);
            updateProgress(0, '生成失败');
            
            // 重置按钮
            generateBtn.disabled = false;
            generateBtn.textContent = '🎬 开始生成视频';
            generateBtn.style.backgroundColor = '#28a745';
            
            alert(`视频生成失败: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('生成视频时出错:', error);
        addLog(`[ERROR] 网络错误: ${error.message}`);
        updateProgress(0, '生成失败');
        
        // 重置按钮
        generateBtn.disabled = false;
        generateBtn.textContent = '🎬 开始生成视频';
        generateBtn.style.backgroundColor = '#28a745';
        
        alert('生成视频时发生网络错误，请检查网络连接');
    });
}

// 更新进度条
function updateProgress(percent, statusText) {
    const progressBar = document.querySelector('div[style*="background-color: #28a745"]');
    const statusSpan = document.querySelector('span[style*="color: #666"]:last-of-type');
    
    if (progressBar) {
        progressBar.style.width = percent + '%';
    }
    if (statusSpan) {
        statusSpan.textContent = statusText;
    }
}

// 添加日志
function addLog(message) {
    const logContainer = document.querySelector('div[style*="background-color: #000"]');
    if (logContainer) {
        const logEntry = document.createElement('div');
        const timestamp = new Date().toLocaleTimeString();
        logEntry.textContent = `[${timestamp}] ${message}`;
        
        // 根据消息类型设置颜色
        if (message.includes('[ERROR]')) {
            logEntry.style.color = '#ff6b6b';
        } else if (message.includes('[SUCCESS]')) {
            logEntry.style.color = '#51cf66';
        } else if (message.includes('[INFO]')) {
            logEntry.style.color = '#74c0fc';
        } else {
            logEntry.style.color = '#00ff00';
        }
        
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }
}

// 生成默认文件名
function generateDefaultFilename() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hour = String(now.getHours()).padStart(2, '0');
    const minute = String(now.getMinutes()).padStart(2, '0');
    const second = String(now.getSeconds()).padStart(2, '0');
    
    return `video_${year}${month}${day}_${hour}${minute}${second}`;
}

// 处理分辨率选择变化
function handleResolutionChange() {
    const resolutionSelect = document.getElementById('output-resolution');
    const customInputs = document.getElementById('custom-resolution-inputs');
    
    if (resolutionSelect.value === 'custom') {
        customInputs.style.display = 'block';
    } else {
        customInputs.style.display = 'none';
    }
}

// 处理质量选择变化
function handleQualityChange() {
    const qualitySelect = document.getElementById('output-quality');
    const customInputs = document.getElementById('custom-quality-inputs');
    
    if (qualitySelect.value === 'custom') {
        customInputs.style.display = 'block';
    } else {
        customInputs.style.display = 'none';
    }
}

// 获取输出设置
function getOutputSettings() {
    const resolutionSelect = document.getElementById('output-resolution');
    const qualitySelect = document.getElementById('output-quality');
    const filenameInput = document.getElementById('output-name');
    
    let resolution;
    if (resolutionSelect.value === 'custom') {
        const width = document.getElementById('custom-width').value;
        const height = document.getElementById('custom-height').value;
        if (width && height) {
            resolution = { width: parseInt(width), height: parseInt(height) };
        } else {
            alert('请输入自定义分辨率的宽度和高度');
            return null;
        }
    } else {
        const [width, height] = resolutionSelect.value.split('x').map(Number);
        resolution = { width, height };
    }
    
    let quality = { preset: qualitySelect.value };
    if (qualitySelect.value === 'custom') {
        const videoBitrate = document.getElementById('video-bitrate').value;
        const audioBitrate = document.getElementById('audio-bitrate').value;
        if (videoBitrate && audioBitrate) {
            quality = {
                preset: 'custom',
                videoBitrate: parseInt(videoBitrate),
                audioBitrate: parseInt(audioBitrate)
            };
        } else {
            alert('请输入自定义质量的视频和音频码率');
            return null;
        }
    }
    
    let filename = filenameInput.value.trim();
    if (!filename) {
        filename = generateDefaultFilename();
    }
    
    return {
        resolution,
        quality,
        filename
    };
}

// 加载淡入淡出设置
function loadVideoFadeSettings() {
    if (!currentProjectName) {
        console.warn('项目名称未设置，无法加载淡入淡出设置');
        return;
    }
    
    fetch('/load_video_fade_settings/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            project_name: currentProjectName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新淡入淡出设置输入框
            const fadeInInput = document.getElementById('fade-in-frames');
            const fadeOutInput = document.getElementById('fade-out-frames');
            const videoFpsInput = document.getElementById('video-fps');
            
            if (fadeInInput) fadeInInput.value = data.fade_in_frames;
            if (fadeOutInput) fadeOutInput.value = data.fade_out_frames;
            if (videoFpsInput) videoFpsInput.value = data.video_fps;
            
            console.log('淡入淡出设置加载成功:', data);
        } else {
            console.warn('加载淡入淡出设置失败:', data.error);
        }
    })
    .catch(error => {
        console.error('加载淡入淡出设置时出错:', error);
    });
}

// 页面加载完成后的初始化
document.addEventListener('DOMContentLoaded', function() {
    // 初始化音量显示
    const volumeSlider = document.getElementById('music-volume');
    const volumeDisplay = document.getElementById('music-volume-display');
    if (volumeSlider && volumeDisplay) {
        volumeDisplay.textContent = volumeSlider.value + '%';
    }
    
    // 初始化默认文件名
    const filenameInput = document.getElementById('output-name');
    if (filenameInput && !filenameInput.value) {
        filenameInput.placeholder = generateDefaultFilename();
    }
    
    // 加载项目信息
    loadCurrentProjectInfo().then(success => {
        if (success) {
            console.log('项目信息加载成功');
            // 加载淡入淡出设置
            loadVideoFadeSettings();
        } else {
            console.error('无法加载项目信息');
        }
    });
    
    // 绑定事件监听器
    document.getElementById('generate-video').addEventListener('click', generateVideo);
    
    // 绑定输出设置相关事件
    document.getElementById('output-resolution').addEventListener('change', handleResolutionChange);
    document.getElementById('output-quality').addEventListener('change', handleQualityChange);
});
</script>

{% endblock %}